<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>TwT Streamer</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>

    document.addEventListener('DOMContentLoaded',function () {


      console.log("It works!");
      const socket = new WebSocket(`ws://${window.location.hostname}:${window.location.port}`);

      socket.addEventListener('open', event => {
        console.log("connected", event);
      });


      socket.addEventListener('message', event => {
        let res = JSON.parse(event.data);
        console.log("new message", res);

        switch (res.event) {
          case "initialTweets":
            res.data.forEach((tweet) => {
              console.log("init", tweet);
              printTweetImg(tweet,socket);
            })
            break;
          case "realTimeTweet":
            printTweetImg(res.data,socket);
            break;
          default:
            console.log("undefined event")
        }

        

        // else
        // if (tweet.retweeted_status.entities.media[0].media_url)
        // {
        //   testImg.setAttribute("src",tweet.retweeted_status.entities.media[0].media_url)
        // }

        socket.send(JSON.stringify({event:"msg", data:"message received!"}));
      });
    })


  </script>
</head>

<body>
  <p>Hello world!</p>
  <div class="message-test"></div>
  <img class="test-img" src="" alt="" width="200">
</body>
  <div class="tweet-list"></div>
</html>

<script>
  function printTweetImg(tweet,socket){

    let body = document.querySelector("body");
    console.log("jui pas la ")
    if (!tweet.retweeted_status) {


      let newImg = document.createElement("img");

      if (tweet.extended_tweet){

        if (tweet.extended_tweet.entities.media)
        {
          newImg.setAttribute("src",tweet.extended_tweet.entities.media[0].media_url);
          newImg.setAttribute("width","200");

        }
      } else{
        if (tweet.entities.media)
        {
          newImg.setAttribute("src",tweet.entities.media[0].media_url);
          newImg.setAttribute("width","200");
          newImg.addEventListener("click",handleClick.bind(this,tweet,socket));
        }}

      body.prepend(newImg);
    }
  }
  function handleClick(tweet,socket) {
    console.log("noot noot");
    socket.send(JSON.stringify({event:"comment",data:tweet}));
  }

</script>